"use strict";var Ajv=require("ajv"),ajv=new Ajv,addFormats=require("ajv-formats");addFormats(ajv);var bcrypt=require("bcrypt"),jwt=require("jsonwebtoken"),dotenv=require("dotenv").config(),_require=require("../models/queryModel"),query=_require.query;exports.validateBody=function(n){return function(e,r,t){ajv.validate(n,e.body)?t():r.status(400).send(ajv.errors[0].message)}},exports.checkEmailValidSignUp=function(r,t,n){var a,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.body.email,e.next=4,regeneratorRuntime.awrap(query("SELECT * FROM users WHERE email = '".concat(a.toLowerCase(),"'")));case 4:(s=e.sent).push("not found"),"not found"===s[0]?n():t.status(400).send("email already taken"),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),console.error(e.t0);case 12:case"end":return e.stop()}},null,null,[[0,9]])},exports.checkPasswordsMatch=function(e,r,t){try{var n=e.body;n.password===n.rePassword?t():r.status(400).send("passwords don't match!")}catch(e){console.error(e)}},exports.encryptPwd=function(t,n,a){try{var e=t.body.password;bcrypt.hash(e,10,function(e,r){e?n.status(500).send("Error Encrypting"):(t.body.password=r,a())})}catch(e){console.error(e)}},exports.decryptPwd=function(t,r,n){var a,s,o,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=t.body,s=a.email,o=a.password,e.next=4,regeneratorRuntime.awrap(query("SELECT * FROM users WHERE email = '".concat(s.toLowerCase(),"'")));case 4:(c=e.sent).push("not found"),"not found"===c[0]?r.status(400).send("email not found!"):bcrypt.compare(o,c[0].password,function(e,r){if(e)throw new Error("Incorrect password");r&&(t.body.user=c[0],n())}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),r.status(400).send(e.t0);case 12:case"end":return e.stop()}},null,null,[[0,9]])},exports.createToken=function(e,r,t){try{var n=e.body.user,a=jwt.sign({userID:n.user_ID},process.env.SECRET_KEY,{expiresIn:"1h"});e.token=a,t()}catch(e){console.error(e)}},exports.authorization=function(t,n,a){try{var e=t.headers.authorization;if(!e)return void n.status(401).send("Must provide a token");var r=e.replace("Bearer ","");jwt.verify(r,process.env.SECRET_KEY,function(e,r){e?n.status(401).send("Invalid Token"):(t.decoded=r,a())})}catch(e){console.error(e)}},exports.checkOldPasswordCorrect=function(r,t,n){var a,s,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.body.oldPassword,s=r.decoded,e.next=5,regeneratorRuntime.awrap(query("SELECT * FROM users WHERE user_ID = '".concat(s.userID,"'")));case 5:(o=e.sent).push("not found"),"not found"===o[0]?t.status(400).send("user not found!"):bcrypt.compare(a,o[0].password,function(e,r){if(e)throw new Error("Incorrect password");r&&n()}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),t.status(400).send(e.t0);case 13:case"end":return e.stop()}},null,null,[[0,10]])},exports.checkEmailValidProfileUpdate=function(r,t,n){var a,s,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.body.email,s=r.decoded,e.next=5,regeneratorRuntime.awrap(query("SELECT * FROM users WHERE user_ID = '".concat(s.userID,"'")));case 5:if(e.sent[0].email!==a){e.next=10;break}n(),e.next=15;break;case 10:return e.next=12,regeneratorRuntime.awrap(query("SELECT * FROM users WHERE email = '".concat(a.toLowerCase(),"'")));case 12:(o=e.sent).push("not found"),"not found"===o[0]?n():t.status(400).send("email already taken");case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),console.error(e.t0);case 20:case"end":return e.stop()}},null,null,[[0,17]])},exports.checkIfStillAvailable=function(r,t,n){var a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.body.petID,e.next=4,regeneratorRuntime.awrap(query("SELECT availability FROM pets WHERE pet_ID = '".concat(a,"'")));case 4:1===e.sent[0].availability?n():t.send("Sorry this pet is no longer available"),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),console.error(e.t0);case 11:case"end":return e.stop()}},null,null,[[0,8]])};