"use strict";var Ajv=require("ajv"),ajv=new Ajv,addFormats=require("ajv-formats");addFormats(ajv);var bcrypt=require("bcrypt"),jwt=require("jsonwebtoken"),dotenv=require("dotenv").config(),_require=require("../models/queryModel"),query=_require.query;exports.validateBody=function(n){return function(e,r,t){ajv.validate(n,e.body)?t():r.status(400).send(ajv.errors[0].message)}},exports.checkEmailValidSignUp=function(r,t,n){var a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.body.email,e.next=4,regeneratorRuntime.awrap(query("SELECT * FROM users WHERE email = '".concat(a.toLowerCase(),"'")));case 4:0===e.sent.length?n():t.status(400).send("email already taken"),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),console.error(e.t0);case 11:case"end":return e.stop()}},null,null,[[0,8]])},exports.checkPasswordsMatch=function(e,r,t){try{var n=e.body;n.password===n.rePassword?t():r.status(400).send("passwords don't match!")}catch(e){console.error(e)}},exports.encryptPwd=function(t,n,a){try{var e=t.body.password;bcrypt.hash(e,10,function(e,r){e?n.status(500).send("Error Encrypting"):(t.body.password=r,a())})}catch(e){console.error(e)}},exports.decryptPwd=function(t,n,a){var r,s,o,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=t.body,s=r.email,o=r.password,e.next=4,regeneratorRuntime.awrap(query("SELECT * FROM users WHERE email = '".concat(s.toLowerCase(),"'")));case 4:0===(c=e.sent).length?n.status(400).send("Email not found!"):bcrypt.compare(o,c[0].password,function(e,r){r?(t.body.user=c[0],a()):n.status(400).send("Wrong Password!")}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n.status(400).send(e.t0);case 11:case"end":return e.stop()}},null,null,[[0,8]])},exports.createToken=function(e,r,t){try{var n=e.body.user,a=jwt.sign({userID:n.user_ID},process.env.SECRET_KEY,{expiresIn:"1h"});e.token=a,t()}catch(e){console.error(e)}},exports.authorization=function(t,n,a){try{var e=t.headers.authorization;if(!e)return void n.status(401).send("Must provide a token");var r=e.replace("Bearer ","");jwt.verify(r,process.env.SECRET_KEY,function(e,r){e?n.status(401).send("Invalid Token"):(t.decoded=r,a())})}catch(e){console.error(e)}},exports.checkOldPasswordCorrect=function(r,t,n){var a,s,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.body.oldPassword,s=r.decoded.userID,e.next=5,regeneratorRuntime.awrap(query("SELECT * FROM users WHERE user_ID = '".concat(s,"'")));case 5:0===(o=e.sent).length?t.status(400).send("user not found!"):bcrypt.compare(a,o[0].password,function(e,r){r?n():t.status(400).send("Wrong Password!")}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),t.status(400).send(e.t0);case 12:case"end":return e.stop()}},null,null,[[0,9]])},exports.checkEmailValidProfileUpdate=function(r,t,n){var a,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.body.email,s=r.decoded.userID,e.next=5,regeneratorRuntime.awrap(query("SELECT * FROM users WHERE user_ID = '".concat(s,"'")));case 5:if(e.sent[0].email!==a){e.next=10;break}n(),e.next=14;break;case 10:return e.next=12,regeneratorRuntime.awrap(query("SELECT * FROM users WHERE email = '".concat(a.toLowerCase(),"'")));case 12:0===e.sent.length?n():t.status(400).send("email already taken");case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),console.error(e.t0);case 19:case"end":return e.stop()}},null,null,[[0,16]])},exports.checkIfStillAvailable=function(r,t,n){var a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.body.petID,e.next=4,regeneratorRuntime.awrap(query("SELECT availability FROM pets WHERE pet_ID = '".concat(a,"'")));case 4:1===e.sent[0].availability?n():t.send("Sorry this pet is no longer available"),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),console.error(e.t0);case 11:case"end":return e.stop()}},null,null,[[0,8]])},exports.checkAdminAccountCreated=function(e,r,t){try{var n=e.body.adminCode;if(n){if(n!==process.env.ADMIN_CODE)return void r.status(400).send("admin code not correct");t()}else t()}catch(e){console.error(e)}},exports.checkAdminForAllReq=function(r,t,n){var a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.decoded.userID,e.next=4,regeneratorRuntime.awrap(query("SELECT * FROM users WHERE user_ID = '".concat(a,"'")));case 4:1===e.sent[0].admin_status?n():t.status(400).send("you are not authorised to do that!!"),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),console.error(e.t0);case 11:case"end":return e.stop()}},null,null,[[0,8]])};