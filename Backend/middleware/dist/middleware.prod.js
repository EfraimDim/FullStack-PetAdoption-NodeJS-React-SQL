"use strict";var Ajv=require("ajv"),ajv=new Ajv,addFormats=require("ajv-formats");addFormats(ajv);var bcrypt=require("bcrypt"),jwt=require("jsonwebtoken"),middlewareQueries=require("../queries/middlewareQueries");exports.validateBody=function(a){return function(e,r,t){ajv.validate(a,e.body)?t():r.status(400).send(ajv.errors[0].message)}},exports.checkEmailValidSignUp=function(r,t,a){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.body.email,e.next=4,regeneratorRuntime.awrap(middlewareQueries.emailValidationQuery(n));case 4:0===e.sent.length?a():t.status(400).send("email already taken"),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),console.error(e.t0);case 11:case"end":return e.stop()}},null,null,[[0,8]])},exports.checkPasswordsMatch=function(e,r,t){try{var a=e.body;a.password===a.rePassword?t():r.status(400).send("passwords don't match!")}catch(e){console.error(e)}},exports.encryptPwd=function(t,a,n){try{var e=t.body.password;bcrypt.hash(e,10,function(e,r){e?a.status(500).send("Error Encrypting"):(t.body.password=r,n())})}catch(e){console.error(e)}},exports.decryptPwd=function(t,a,n){var r,s,o,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=t.body,s=r.email,o=r.password,e.next=4,regeneratorRuntime.awrap(middlewareQueries.emailValidationQuery(s));case 4:0===(c=e.sent).length?a.status(400).send("Email not found!"):bcrypt.compare(o,c[0].password,function(e,r){r?(t.body.user=c[0],n()):a.status(400).send("Wrong Password!")}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),a.status(400).send(e.t0);case 11:case"end":return e.stop()}},null,null,[[0,8]])},exports.createToken=function(e,r,t){try{var a=e.body.user,n=jwt.sign({userID:a.user_ID},process.env.SECRET_KEY,{expiresIn:"1h"});e.token=n,t()}catch(e){console.error(e)}},exports.authorization=function(t,a,n){try{var e=t.headers.authorization;if(!e)return void a.status(401).send("Must provide a token");var r=e.replace("Bearer ","");jwt.verify(r,process.env.SECRET_KEY,function(e,r){e?a.status(401).send("Invalid Token"):(t.decoded=r,n())})}catch(e){console.error(e)}},exports.checkOldPasswordCorrect=function(r,t,a){var n,s,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.body.oldPassword,s=r.decoded.userID,e.next=5,regeneratorRuntime.awrap(middlewareQueries.userIDValidationQuery(s));case 5:0===(o=e.sent).length?t.status(400).send("user not found!"):bcrypt.compare(n,o[0].password,function(e,r){r?a():t.status(400).send("Wrong Password!")}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),t.status(400).send(e.t0);case 12:case"end":return e.stop()}},null,null,[[0,9]])},exports.checkEmailValidProfileUpdate=function(r,t,a){var n,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.body.email,s=r.decoded.userID,e.next=5,regeneratorRuntime.awrap(middlewareQueries.userIDValidationQuery(s));case 5:if(e.sent[0].email!==n){e.next=10;break}a(),e.next=14;break;case 10:return e.next=12,regeneratorRuntime.awrap(middlewareQueries.emailValidationQuery(n));case 12:0===e.sent.length?a():t.status(400).send("email already taken");case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),console.error(e.t0);case 19:case"end":return e.stop()}},null,null,[[0,16]])},exports.checkIfStillAvailable=function(r,t,a){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.body.petID,e.next=4,regeneratorRuntime.awrap(middlewareQueries.availabilityCheckQuery(n));case 4:1===e.sent[0].availability?a():t.send("Sorry this pet is no longer available"),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),console.error(e.t0);case 11:case"end":return e.stop()}},null,null,[[0,8]])},exports.checkAdminAccountCreated=function(e,r,t){try{var a=e.body.adminCode;if(a){if(a!==process.env.ADMIN_CODE)return void r.status(400).send("admin code not correct");t()}else t()}catch(e){console.error(e)}},exports.checkAdminForAllReq=function(r,t,a){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.decoded.userID,e.next=4,regeneratorRuntime.awrap(middlewareQueries.userIDValidationQuery(n));case 4:1===e.sent[0].admin_status?a():t.status(400).send("you are not authorised to do that!!"),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),console.error(e.t0);case 11:case"end":return e.stop()}},null,null,[[0,8]])};