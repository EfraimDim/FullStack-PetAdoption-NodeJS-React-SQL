"use strict";var Ajv=require("ajv"),ajv=new Ajv,addFormats=require("ajv-formats");addFormats(ajv);var bcrypt=require("bcrypt"),jwt=require("jsonwebtoken"),dotenv=require("dotenv").config();exports.validateBody=function(t){return function(r,e,s){ajv.validate(t,r.body)?s():e.status(400).send(ajv.errors[0].message)}},exports.encryptPwd=function(s,t,o){try{var r=s.body.password;bcrypt.hash(r,10,function(r,e){r?t.status(500).send("Error Encrypting"):(s.body.password=e,o())})}catch(r){console.error(r)}},exports.decryptPwd=function(r,e,s){try{var t=r.body,o=t.email,n=t.password,a=users.users.find(function(r){return r.email===o});bcrypt.compare(n,a.password,function(r,e){if(r)throw new Error("Incorrect password");e&&s()})}catch(r){e.status(400).send(r)}},exports.authorization=function(s,t,o){try{var r=s.headers.authorization;if(!r)return void t.status(401).send("Must provide a token");var e=r.replace("Bearer ","");jwt.verify(e,process.env.SECRET_KEY,function(r,e){r?t.status(401).send("Invalid Token"):(s.decoded=e,o())})}catch(r){console.error(r)}},exports.authorizeEdit=function(r,e,s){try{var t=r.decoded.userID,o=r.body.postID,n=users.findUser(t),a=allPosts.findPost(o);n.username===a.poster?s():e.status(400).send("You are not authroized to do that!")}catch(r){console.error(r)}},exports.authorizeDelete=function(r,e,s){try{var t=r.decoded.userID,o=r.params.postID,n=users.findUser(t),a=allPosts.findPost(o);n.username===a.poster?s():e.status(400).send("You are not authroized to do that!")}catch(r){console.error(r)}},exports.createToken=function(e,r,s){try{var t=users.users.find(function(r){return e.body.email===r.email}),o=jwt.sign({userID:t.userID},process.env.SECRET_KEY,{expiresIn:"1h"});e.token=o,s()}catch(r){console.error(r)}},exports.checkPassword=function(r,e,s){try{var t=r.body;t.password===t.repassword?s():e.status(400).send("passwords don't match!")}catch(r){console.error(r)}},exports.checkEmailAndUsernameValid=function(r,e,s){try{var t=r.body,o=t.email,n=t.username,a=users.users.find(function(r){return r.email===o}),d=users.users.find(function(r){return r.username===n});a||d?e.status(400).send("email already taken"):s()}catch(r){console.error(r)}};